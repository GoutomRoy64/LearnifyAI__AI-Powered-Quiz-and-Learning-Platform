<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome - LearnifyAI</title>
    <!-- Link to the custom CSS file -->
    <link rel="stylesheet" href="registration.css">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="container">
        <div class="auth-wrapper">
            <!-- Left Side: Welcome Message -->
            <div class="welcome-panel">
                <a href="index.html" class="logo">
                    <i class="fas fa-brain"></i> Learnify<span>AI</span>
                </a>
                <h1>Unlock Your Learning Potential</h1>
                <p>Join a community of learners and educators. Get started with AI-powered quizzes and personalized feedback today!</p>
            </div>

            <!-- Right Side: Form Panel -->
            <div class="form-panel">
                <!-- Login Form -->
                <div id="login-form">
                    <div class="form-header">
                        <h2>Welcome Back!</h2>
                        <p>Don't have an account? <a href="#" onclick="toggleForm('signup', event)">Sign Up</a></p>
                    </div>
                    
                    <div id="success-message" class="hidden success-message" role="alert">
                        <strong class="font-bold">Success!</strong>
                        <span class="block sm:inline">Your account was created. Please log in to continue.</span>
                    </div>

                    <form id="login-form-element">
                        <div class="input-group">
                            <label for="login-email">Email Address</label>
                            <div class="input-field">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="login-email" placeholder="you@example.com" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="login-password">Password</label>
                            <div class="input-field">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="login-password" placeholder="Enter your password" required>
                            </div>
                        </div>
                        <button type="submit" class="btn-submit">
                            <span class="button-text">Log In</span>
                            <span class="spinner hidden"></span>
                        </button>
                    </form>
                </div>

                <!-- Registration Form -->
                <div id="signup-form" class="hidden">
                     <div class="form-header">
                        <h2>Create an Account</h2>
                        <p>Already have an account? <a href="#" onclick="toggleForm('login', event)">Log In</a></p>
                    </div>
                    <form id="signup-form-element">
                        <div class="input-group">
                            <label for="fullName">Full Name</label>
                            <div class="input-field">
                                <i class="fas fa-user"></i>
                                <input type="text" id="fullName" placeholder="John Doe" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="signup-email">Email Address</label>
                            <div class="input-field">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="signup-email" placeholder="you@example.com" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="signup-password">Password</label>
                            <div class="input-field">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="signup-password" placeholder="Minimum 8 characters" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="userRole">I am a...</label>
                            <div class="input-field">
                                <i class="fas fa-user-graduate"></i>
                                <select id="userRole">
                                    <option value="student">Student</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="guardian">Guardian</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn-submit">
                            <span class="button-text">Sign Up</span>
                            <span class="spinner hidden"></span>
                        </button>
                    </form>
                </div>
                
                <div class="divider"><span>OR</span></div>
                <button type="button" class="btn-google" id="google-signin-btn"><i class="fab fa-google"></i> Continue with Google</button>
            </div>
        </div>
    </div>

    <script>
        function toggleForm(formToShow, event) {
            if (event) event.preventDefault();
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            if (formToShow === 'signup') {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            } else {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            }
        }
    </script>

    <!-- Firebase SDK (Software Development Kit) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <!-- Load keys from the separate, gitignored file -->
    <script src="firebase-keys.js"></script>

    <!-- Main Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // Initialize Firebase using firebaseConfig from firebase-keys.js
            firebase.initializeApp(firebaseConfig);
            
            // Define auth and db constants for use in functions
            const auth = firebase.auth();
            const db = firebase.firestore();

            const signupFormEl = document.getElementById('signup-form-element');
            const loginFormEl = document.getElementById('login-form-element');
            const successMessageEl = document.getElementById('success-message');

            function setLoading(button, isLoading) {
                const buttonText = button.querySelector('.button-text');
                const spinner = button.querySelector('.spinner');
                button.disabled = isLoading;
                buttonText.classList.toggle('hidden', isLoading);
                spinner.classList.toggle('hidden', !isLoading);
            }

            signupFormEl.addEventListener('submit', e => {
                e.preventDefault();
                const signupButton = signupFormEl.querySelector('.btn-submit');
                setLoading(signupButton, true);
                
                const fullName = signupFormEl['fullName'].value;
                const email = signupFormEl['signup-email'].value;
                const password = signupFormEl['signup-password'].value;
                const userRole = signupFormEl['userRole'].value;

                auth.createUserWithEmailAndPassword(email, password)
                    .then(cred => db.collection('users').doc(cred.user.uid).set({
                        name: fullName,
                        role: userRole,
                        email: email
                    }))
                    .then(() => {
                        signupFormEl.reset();
                        document.getElementById('login-email').value = email;
                        successMessageEl.classList.remove('hidden');
                        toggleForm('login');
                    })
                    .catch(err => {
                        console.error("Registration Error:", err);
                        alert('Error: ' + err.message);
                    })
                    .finally(() => setLoading(signupButton, false));
            });

            loginFormEl.addEventListener('submit', e => {
                e.preventDefault();
                const loginButton = loginFormEl.querySelector('.btn-submit');
                setLoading(loginButton, true);
                
                const email = loginFormEl['login-email'].value;
                const password = loginFormEl['login-password'].value;

                auth.signInWithEmailAndPassword(email, password)
                    .catch(err => {
                        console.error("Login Error:", err);
                        alert('Error: ' + err.message);
                        setLoading(loginButton, false); 
                    });
            });
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    const loginButton = loginFormEl.querySelector('.btn-submit');
                    if(loginButton.disabled) {
                        db.collection('users').doc(user.uid).get()
                            .then(doc => {
                                if (doc.exists) {
                                    redirectToDashboard(doc.data().role);
                                } else {
                                    throw new Error('User data not found.');
                                }
                            })
                            .catch(err => {
                                console.error(err);
                                alert(err.message);
                                setLoading(loginButton, false);
                            });
                    }
                }
            });

            function redirectToDashboard(role) {
                const dashboardPaths = {
                    student: 'student_dashboard.html',
                    teacher: 'teacher_dashboard.html',
                    guardian: 'guardian_dashboard.html'
                };
                window.location.href = dashboardPaths[role] || 'index.html';
            }
        });
    </script>
</body>
</html>
