<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Quiz - LearnifyAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/quiz.css">
    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.mjs" type="module"></script>
</head>
<body class="bg-gray-50">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-8">
                    <a href="../../index.html" class="text-2xl font-bold text-gray-800">Learnify<span class="text-indigo-600">AI</span></a>
                </div>
                <div>
                    <a href="../dashboard/page.html" class="text-gray-600 font-semibold hover:text-indigo-600">Back to Dashboard</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto py-10 sm:px-6 lg:px-8">
        <form id="create-quiz-form">
            <!-- Quiz Details Section -->
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Create a New Quiz</h2>
                        <p class="text-gray-500 mt-1">Fill out the details below and add your questions.</p>
                    </div>
                    <button type="button" id="generate-ai-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        Generate with AI
                    </button>
                </div>
                
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="quiz-title" class="block text-sm font-medium text-gray-700">Quiz Title</label>
                        <input type="text" id="quiz-title" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div>
                        <label for="quiz-subject" class="block text-sm font-medium text-gray-700">Subject</label>
                        <input type="text" id="quiz-subject" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div>
                        <label for="skill-level" class="block text-sm font-medium text-gray-700">Skill Level</label>
                        <select id="skill-level" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm" required>
                            <option>Beginner</option>
                            <option>Intermediate</option>
                            <option>Advanced</option>
                        </select>
                    </div>
                     <div>
                        <label for="quiz-timer" class="block text-sm font-medium text-gray-700">Timer (minutes)</label>
                        <input type="number" id="quiz-timer" placeholder="e.g., 10" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
            </div>

            <!-- Questions Section -->
            <div id="questions-container" class="mt-8 space-y-6">
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex justify-between items-center">
                <button type="button" id="add-question-btn" class="bg-green-500 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-green-600">
                    Add Question
                </button>
                <button type="submit" id="save-quiz-btn" class="bg-indigo-600 text-white px-8 py-2.5 rounded-lg font-semibold hover:bg-indigo-700">
                    Save Quiz
                </button>
            </div>
        </form>
    </main>
    
    <!-- AI Generation Modal -->
    <div id="ai-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden items-center justify-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-900">AI-Assisted Quiz Generation</h3>
                <button id="ai-modal-close-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <p class="text-sm text-gray-500 mb-6">Generate questions from text, a PDF, or a YouTube video.</p>
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6" id="ai-tabs">
                    <button data-tab="text" class="ai-tab active py-3 px-1 text-sm font-semibold">Text</button>
                    <button data-tab="pdf" class="ai-tab py-3 px-1 text-sm font-semibold text-gray-500">PDF</button>
                    <button data-tab="youtube" class="ai-tab py-3 px-1 text-sm font-semibold text-gray-500" disabled>YouTube (Coming Soon)</button>
                </nav>
            </div>
            <form id="ai-generate-form" class="mt-6 space-y-4">
                <div id="text-input-area">
                    <label for="ai-context" class="block text-sm font-medium text-gray-700">Topic or Text Content</label>
                    <textarea id="ai-context" rows="6" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" placeholder="Enter a topic..."></textarea>
                </div>
                <div id="pdf-input-area" class="hidden">
                    <label for="ai-pdf" class="block text-sm font-medium text-gray-700">Upload PDF</label>
                    <input type="file" id="ai-pdf" accept=".pdf" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                </div>
                <div id="youtube-input-area" class="hidden">
                    <!-- Content for this tab is handled by the tab switching logic -->
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="ai-skill-level" class="block text-sm font-medium text-gray-700">Skill Level</label>
                        <select id="ai-skill-level" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm" required>
                            <option>Beginner</option>
                            <option>Intermediate</option>
                            <option>Advanced</option>
                        </select>
                    </div>
                    <div>
                        <label for="ai-num-questions" class="block text-sm font-medium text-gray-700">Number of Questions</label>
                        <input type="number" id="ai-num-questions" value="5" min="1" class="mt-1 w-full border-gray-300 rounded-md shadow-sm" placeholder="e.g., 5">
                    </div>
                </div>
                <div class="text-right pt-4">
                    <button type="submit" class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-indigo-700 w-full flex items-center justify-center">
                        <span id="ai-gen-text">Generate Questions</span>
                        <div id="ai-gen-loader" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { firebaseConfig } from '../../firebase-keys.js';
        import { generateQuizFromContext } from '../../ai/flows/generate_quiz.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { pdfjsLib } = globalThis;
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.mjs`;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        const questionsContainer = document.getElementById('questions-container');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const createQuizForm = document.getElementById('create-quiz-form');
        
        const aiModal = document.getElementById('ai-modal');
        const generateAiBtn = document.getElementById('generate-ai-btn');
        const aiModalCloseBtn = document.getElementById('ai-modal-close-btn');
        const aiGenerateForm = document.getElementById('ai-generate-form');
        const aiGenLoader = document.getElementById('ai-gen-loader');
        const aiGenText = document.getElementById('ai-gen-text');
        const aiTabs = document.getElementById('ai-tabs');
        const textInputArea = document.getElementById('text-input-area');
        const pdfInputArea = document.getElementById('pdf-input-area');
        const youtubeInputArea = document.getElementById('youtube-input-area');

        const addOption = (optionsContainer, questionIndex, optionText = '', isCorrect = false) => {
            const optionIndex = optionsContainer.children.length;
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-input-group';
            optionDiv.innerHTML = `
                <input type="radio" name="correct-answer-${questionIndex}" value="${optionIndex}" class="h-4 w-4 text-indigo-600 border-gray-300" required ${isCorrect ? 'checked' : ''}>
                <input type="text" class="option-text block w-full px-3 py-2 border border-gray-300 rounded-md" value="${optionText}" required>
                <button type="button" class="remove-option-btn text-gray-400 hover:text-red-600">&times;</button>
            `;
            optionsContainer.appendChild(optionDiv);
            optionDiv.querySelector('.remove-option-btn').addEventListener('click', () => optionDiv.remove());
        };

        const addQuestionCard = (questionData = null) => {
            const questionIndex = questionsContainer.children.length;
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-xl shadow-sm border border-gray-200 question-card';
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-700">Question ${questionIndex + 1}</h3>
                    <button type="button" class="remove-question-btn text-red-500 hover:text-red-700 font-semibold">Remove</button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Question Text</label>
                    <textarea class="question-text mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>${questionData ? questionData.questionText : ''}</textarea>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">Options</label>
                    <div class="options-container mt-2 space-y-2"></div>
                    <button type="button" class="add-option-btn mt-2 text-sm text-indigo-600">+ Add Option</button>
                </div>
            `;
            questionsContainer.appendChild(card);
            
            const optionsContainer = card.querySelector('.options-container');
            const addOptionBtn = card.querySelector('.add-option-btn');
            addOptionBtn.addEventListener('click', () => addOption(optionsContainer, questionIndex));

            if (questionData && questionData.options) {
                questionData.options.forEach((opt, i) => {
                    addOption(optionsContainer, questionIndex, opt, i === questionData.correctAnswerIndex);
                });
            } else {
                addOption(optionsContainer, questionIndex);
                addOption(optionsContainer, questionIndex);
            }
            card.querySelector('.remove-question-btn').addEventListener('click', () => card.remove());
        };

        generateAiBtn.addEventListener('click', () => aiModal.style.display = 'flex');
        aiModalCloseBtn.addEventListener('click', () => aiModal.style.display = 'none');
        
        aiTabs.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON' || e.target.disabled) return;
            aiTabs.querySelectorAll('.ai-tab').forEach(tab => tab.classList.remove('active'));
            e.target.classList.add('active');
            textInputArea.classList.toggle('hidden', e.target.dataset.tab !== 'text');
            pdfInputArea.classList.toggle('hidden', e.target.dataset.tab !== 'pdf');
            youtubeInputArea.classList.toggle('hidden', e.target.dataset.tab !== 'youtube');
        });

        const extractTextFromPdf = async (file) => {
            const fileReader = new FileReader();
            return new Promise((resolve, reject) => {
                fileReader.onload = async (event) => {
                    try {
                        const typedarray = new Uint8Array(event.target.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let textContent = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const text = await page.getTextContent();
                            textContent += text.items.map(s => s.str).join(' ');
                        }
                        resolve(textContent);
                    } catch (error) {
                        reject(error);
                    }
                };
                fileReader.onerror = reject;
                fileReader.readAsArrayBuffer(file);
            });
        };

        aiGenerateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            let context = '';
            const activeTab = aiTabs.querySelector('.active').dataset.tab;
            
            aiGenText.style.display = 'none';
            aiGenLoader.style.display = 'block';

            try {
                if (activeTab === 'text') {
                    context = document.getElementById('ai-context').value;
                    if (!context.trim()) throw new Error("Text content cannot be empty.");
                } else if (activeTab === 'pdf') {
                    const pdfFile = document.getElementById('ai-pdf').files[0];
                    if (!pdfFile) throw new Error("Please select a PDF file.");
                    context = await extractTextFromPdf(pdfFile);
                }

                const numQuestions = document.getElementById('ai-num-questions').value;
                const skillLevel = document.getElementById('ai-skill-level').value;

                const generatedQuestions = await generateQuizFromContext(context, numQuestions, skillLevel);
                questionsContainer.innerHTML = '';
                generatedQuestions.forEach(q => addQuestionCard(q));
                aiModal.style.display = 'none';

            } catch (error) {
                alert(`AI Generation Failed: ${error.message}`);
            } finally {
                aiGenText.style.display = 'block';
                aiGenLoader.style.display = 'none';
            }
        });

        addQuestionBtn.addEventListener('click', () => addQuestionCard());

        createQuizForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                alert("You must be logged in to create a quiz.");
                return;
            }

            const quizData = {
                title: document.getElementById('quiz-title').value,
                subject: document.getElementById('quiz-subject').value,
                skillLevel: document.getElementById('skill-level').value,
                teacherId: currentUser.uid,
                createdAt: new Date(),
                questionsCount: questionsContainer.children.length,
                attempts: 0,
                classroom: "public"
            };

            if (quizData.questionsCount === 0) {
                alert("Please add at least one question.");
                return;
            }

            try {
                const quizDocRef = await addDoc(collection(db, "quizzes"), quizData);
                const batch = writeBatch(db);
                const questionCards = questionsContainer.querySelectorAll('.question-card');

                questionCards.forEach((card) => {
                    const questionText = card.querySelector('.question-text').value;
                    const options = Array.from(card.querySelectorAll('.option-text')).map(input => input.value);
                    const correctAnswerIndex = card.querySelector('input[type="radio"]:checked').value;

                    const questionDocRef = doc(collection(db, "quizzes", quizDocRef.id, "questions"));
                    batch.set(questionDocRef, {
                        text: questionText,
                        options: options,
                        correctAnswer: parseInt(correctAnswerIndex)
                    });
                });

                await batch.commit();
                alert("Quiz created successfully!");
                window.location.href = '../dashboard/page.html';
            } catch (error) {
                console.error("Error creating quiz: ", error);
                alert("An error occurred while saving the quiz. Please try again.");
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            } else {
                window.location.href = '../../login/page.html';
            }
        });

        addQuestionCard();
    </script>
</body>
</html>
